<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>要約大魔王</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Courier New', monospace;
            background: linear-gradient(135deg, #0a0a0a, #1a0033, #000d1a);
            color: #00ff00;
            min-height: 100vh;
            overflow-x: hidden;
        }

        .matrix-bg {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
            opacity: 0.1;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            padding: 50px 20px;
            text-align: center;
        }

        .title {
            font-size: 3rem;
            margin-bottom: 20px;
            text-shadow: 0 0 20px #00ff00, 0 0 40px #00ff00;
            animation: glow 2s ease-in-out infinite alternate;
        }

        @keyframes glow {
            from { text-shadow: 0 0 20px #00ff00, 0 0 40px #00ff00; }
            to { text-shadow: 0 0 30px #00ff00, 0 0 60px #00ff00, 0 0 80px #00ff00; }
        }

        .subtitle {
            font-size: 1.2rem;
            margin-bottom: 40px;
            color: #00ccff;
            opacity: 0.8;
        }

        .input-container {
            position: relative;
            margin-bottom: 30px;
        }

        .url-input {
            width: 100%;
            padding: 15px 20px;
            font-size: 1.1rem;
            background: rgba(0, 20, 40, 0.8);
            border: 2px solid #00ff00;
            border-radius: 10px;
            color: #00ff00;
            font-family: 'Courier New', monospace;
            outline: none;
            transition: all 0.3s ease;
        }

        .url-input:focus {
            border-color: #00ccff;
            box-shadow: 0 0 20px rgba(0, 255, 255, 0.5);
        }

        .url-input::placeholder {
            color: #006600;
        }

        .submit-btn {
            padding: 15px 40px;
            font-size: 1.2rem;
            background: linear-gradient(45deg, #ff0080, #8000ff);
            border: none;
            border-radius: 10px;
            color: white;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 2px;
        }

        .submit-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(255, 0, 128, 0.3);
        }

        .submit-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .result-container {
            margin-top: 40px;
            padding: 20px;
            background: rgba(0, 40, 80, 0.6);
            border: 1px solid #00ccff;
            border-radius: 10px;
            display: none;
        }

        .result-title {
            font-size: 1.3rem;
            color: #00ccff;
            margin-bottom: 15px;
        }

        .result-text {
            font-size: 1.1rem;
            line-height: 1.6;
            color: #ffffff;
            padding: 20px;
            background: rgba(0, 0, 0, 0.5);
            border-radius: 5px;
            text-align: left;
        }

        .summary-section {
            margin-bottom: 25px;
            border-left: 3px solid #00ff00;
            padding-left: 15px;
        }

        .summary-label {
            font-size: 0.9rem;
            color: #00ccff;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 8px;
            font-weight: bold;
        }

        .summary-content {
            font-size: 1.1rem;
            color: #ffffff;
            line-height: 1.5;
        }

        .category-tag {
            display: inline-block;
            background: linear-gradient(45deg, #ff0080, #8000ff);
            color: white;
            padding: 4px 12px;
            border-radius: 15px;
            font-size: 0.8rem;
            font-weight: bold;
            margin-right: 8px;
            margin-bottom: 8px;
        }

        .key-points {
            list-style: none;
            padding: 0;
        }

        .key-points li {
            position: relative;
            padding-left: 20px;
            margin-bottom: 8px;
            color: #ffffff;
        }

        .key-points li::before {
            content: '▶';
            position: absolute;
            left: 0;
            color: #00ff00;
            font-size: 0.8rem;
        }

        .loading {
            display: none;
            margin-top: 20px;
        }

        .loading-text {
            color: #00ff00;
            animation: pulse 1s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .error {
            color: #ff4444;
            background: rgba(255, 68, 68, 0.1);
            padding: 15px;
            border-radius: 5px;
            margin-top: 20px;
            display: none;
        }

        .cyber-lines {
            position: fixed;
            width: 2px;
            height: 100%;
            background: linear-gradient(to bottom, transparent, #00ff00, transparent);
            animation: scan 3s linear infinite;
        }

        .cyber-lines:nth-child(1) { left: 10%; animation-delay: 0s; }
        .cyber-lines:nth-child(2) { right: 20%; animation-delay: 1s; }
        .cyber-lines:nth-child(3) { left: 70%; animation-delay: 2s; }

        @keyframes scan {
            0% { transform: translateY(-100%); }
            100% { transform: translateY(100vh); }
        }
    </style>
</head>
<body>
    <div class="cyber-lines"></div>
    <div class="cyber-lines"></div>
    <div class="cyber-lines"></div>
    
    <canvas class="matrix-bg" id="matrix"></canvas>
    
    <!-- 設定ファイル読み込み -->
    <script src="config.js"></script>
    
    <div class="container">
        <h1 class="title">要約大魔王</h1>
        <p class="subtitle">URLを投入せよ。詳細要約を召還する。</p>
        
        <div class="input-container">
            <input type="url" id="urlInput" class="url-input" placeholder="https://example.com を入力...">
        </div>
        
        <button id="summarizeBtn" class="submit-btn">要約実行</button>
        
        <div class="loading" id="loading">
            <div class="loading-text">魔法詠唱中... Webページ解析実行中... 高精度分析処理中...</div>
        </div>
        
        <div class="error" id="error"></div>
        
        <div class="result-container" id="result">
            <h3 class="result-title">召還結果:</h3>
            <div class="result-text" id="resultText"></div>
        </div>
    </div>

    <script>
        // Matrix rain effect
        const canvas = document.getElementById('matrix');
        const ctx = canvas.getContext('2d');

        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;

        const katakana = 'アカサタナハマヤラワガザダバパイキシチニヒミリヰギジヂビピウクスツヌフムユルグズドブプエケセテネヘメレヱゲゼデベペオコソトノホモヨロヲゴゾドボポヴッン0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ';
        const letters = katakana.split('');

        const fontSize = 16;
        const columns = canvas.width / fontSize;

        const drops = [];
        for (let x = 0; x < columns; x++) {
            drops[x] = 1;
        }

        function draw() {
            ctx.fillStyle = 'rgba(0, 0, 0, 0.05)';
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            ctx.fillStyle = '#00ff00';
            ctx.font = fontSize + 'px monospace';

            for (let i = 0; i < drops.length; i++) {
                const text = letters[Math.floor(Math.random() * letters.length)];
                ctx.fillText(text, i * fontSize, drops[i] * fontSize);

                if (drops[i] * fontSize > canvas.height && Math.random() > 0.975) {
                    drops[i] = 0;
                }
                drops[i]++;
            }
        }

        setInterval(draw, 35);

        // Main functionality
        const urlInput = document.getElementById('urlInput');
        const summarizeBtn = document.getElementById('summarizeBtn');
        const loading = document.getElementById('loading');
        const error = document.getElementById('error');
        const result = document.getElementById('result');
        const resultText = document.getElementById('resultText');

        // Google API設定を config.js から取得
        const GOOGLE_API_KEY = window.CONFIG?.GOOGLE_API_KEY || 'YOUR_GOOGLE_API_KEY_HERE';
        const GOOGLE_API_URL = window.CONFIG?.GOOGLE_API_URL || 'https://generativelanguage.googleapis.com/v1beta/models/gemini-pro:generateContent';

        async function fetchWebContent(url) {
            try {
                // 複数のCORSプロキシを試行してコンテンツを取得
                const corsProxies = window.CONFIG?.CORS_PROXIES || [
                    'https://api.allorigins.win/get?url=',
                    'https://corsproxy.io/?',
                    'https://thingproxy.freeboard.io/fetch/'
                ];
                
                const proxies = corsProxies.map(proxy => 
                    proxy.includes('allorigins') 
                        ? `${proxy}${encodeURIComponent(url)}`
                        : `${proxy}${encodeURIComponent(url)}`
                );
                
                let content = null;
                let lastError = null;
                
                for (const proxyUrl of proxies) {
                    try {
                        const response = await fetch(proxyUrl);
                        if (!response.ok) throw new Error(`HTTP ${response.status}`);
                        
                        const data = await response.json();
                        content = data.contents || data;
                        if (content && content.length > 100) break;
                    } catch (err) {
                        lastError = err;
                        continue;
                    }
                }
                
                if (!content) {
                    throw lastError || new Error('全てのプロキシで取得に失敗');
                }
                
                // HTMLコンテンツをクリーンアップ
                return cleanHtmlContent(content);
                
            } catch (err) {
                throw new Error(`ウェブコンテンツの取得に失敗: ${err.message}`);
            }
        }
        
        function cleanHtmlContent(html) {
            // HTMLタグを除去し、テキストのみを抽出
            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = html;
            
            // 不要な要素を除去
            const elementsToRemove = ['script', 'style', 'nav', 'header', 'footer', 'aside', 'advertisement'];
            elementsToRemove.forEach(tag => {
                const elements = tempDiv.querySelectorAll(tag);
                elements.forEach(el => el.remove());
            });
            
            // メインコンテンツを抽出（優先順位付き）
            const contentSelectors = [
                'main', 'article', '[role="main"]', '.content', '.main-content', 
                '.post-content', '.entry-content', '.article-content', 'section'
            ];
            
            let mainContent = '';
            for (const selector of contentSelectors) {
                const element = tempDiv.querySelector(selector);
                if (element && element.textContent.trim().length > 200) {
                    mainContent = element.textContent;
                    break;
                }
            }
            
            // メインコンテンツが見つからない場合はbody全体を使用
            if (!mainContent) {
                mainContent = tempDiv.textContent || html.replace(/<[^>]*>/g, '');
            }
            
            // テキストをクリーンアップ
            return mainContent
                .replace(/\s+/g, ' ')  // 連続する空白を単一スペースに
                .replace(/\n\s*\n/g, '\n')  // 空行を整理
                .trim()
                .substring(0, 8000);  // 文字数制限
        }

        async function summarizeWithGoogle(content) {
            const prompt = `あなたは優秀なウェブコンテンツアナリストです。以下のウェブページの内容を正確に分析し、必ずJSON形式で回答してください。

【重要】必ず以下のJSON形式で回答し、他の文章は一切含めないでください：

{
  "category": "適切なカテゴリ（テクノロジー、ニュース、Eコマース、教育、企業情報、ブログ、エンターテイメント、金融など）",
  "title": "ページの具体的で正確なタイトル（30文字以内）",
  "summary": "ページの核心的な内容を2-3文で正確に要約。推測は避け事実のみ記述",
  "keyPoints": [
    "実際に記載されている重要な情報1",
    "実際に記載されている重要な情報2", 
    "実際に記載されている重要な情報3",
    "実際に記載されている重要な情報4"
  ],
  "target": "コンテンツから推測される主要ターゲット層"
}

【分析対象コンテンツ】
${content}

【注意事項】
- 推測や想像は避け、実際の内容のみを分析
- 不明な点は「情報不足」と明記
- JSON形式以外の回答は禁止
- keyPointsは実際にページに記載されている内容のみ`;
            
            try {
                const response = await fetch(`${GOOGLE_API_URL}?key=${GOOGLE_API_KEY}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        contents: [{
                            parts: [{
                                text: prompt
                            }]
                        }],
                        generationConfig: {
                            temperature: window.CONFIG?.TEMPERATURE || 0.1,
                            topP: 0.8,
                            topK: 40,
                            maxOutputTokens: window.CONFIG?.MAX_OUTPUT_TOKENS || 1024
                        }
                    })
                });

                const data = await response.json();
                
                if (data.candidates && data.candidates[0]) {
                    const responseText = data.candidates[0].content.parts[0].text.trim();
                    
                    // JSONの開始と終了を見つけて抽出
                    const jsonStart = responseText.indexOf('{');
                    const jsonEnd = responseText.lastIndexOf('}') + 1;
                    
                    if (jsonStart >= 0 && jsonEnd > jsonStart) {
                        const jsonText = responseText.substring(jsonStart, jsonEnd);
                        try {
                            const parsed = JSON.parse(jsonText);
                            
                            // 必須フィールドの検証
                            if (!parsed.category || !parsed.title || !parsed.summary) {
                                throw new Error('必須フィールドが不足');
                            }
                            
                            return parsed;
                        } catch (parseError) {
                            console.error('JSON解析エラー:', parseError, 'レスポンス:', jsonText);
                            throw new Error('API応答の解析に失敗');
                        }
                    } else {
                        throw new Error('有効なJSON形式が見つかりません');
                    }
                } else {
                    throw new Error('API応答が無効です');
                }
            } catch (err) {
                throw new Error(`要約生成エラー: ${err.message}`);
            }
        }

        // 実際のコンテンツを簡易分析（デモ用）
        function analyzeContentDemo(content, url) {
            const words = content.toLowerCase().split(/\s+/);
            const domain = new URL(url).hostname;
            
            // キーワード分析でカテゴリを推定
            let category = "一般";
            let title = `${domain}のウェブページ`;
            
            if (words.some(w => ['news', 'ニュース', '記事', 'article'].includes(w))) {
                category = "ニュース";
                title = "ニュース・記事サイト";
            } else if (words.some(w => ['shop', 'buy', '購入', '商品', 'product'].includes(w))) {
                category = "Eコマース";
                title = "オンラインショップ";
            } else if (words.some(w => ['tech', '技術', 'テクノロジー', 'ai', 'プログラミング'].includes(w))) {
                category = "テクノロジー";
                title = "テクノロジー・技術情報サイト";
            } else if (words.some(w => ['company', '会社', '企業', 'about'].includes(w))) {
                category = "企業情報";
                title = "企業・会社情報サイト";
            }
            
            // 実際のコンテンツから概要を作成
            const summary = content.substring(0, 200).replace(/\s+/g, ' ').trim() + '...';
            
            // よく出現する語句からキーポイントを抽出
            const sentences = content.split(/[。！？\.]/).filter(s => s.trim().length > 10);
            const keyPoints = sentences.slice(0, 4).map(s => s.trim().substring(0, 50) + '...');
            
            return {
                category,
                title,
                summary: summary || 'コンテンツの詳細分析を実行しました',
                keyPoints: keyPoints.length > 0 ? keyPoints : ['実際のウェブページ内容を取得', 'コンテンツ分析を実行', '関連情報を抽出', 'キーワード解析を完了'],
                target: category === "テクノロジー" ? "エンジニア・技術者" : 
                       category === "Eコマース" ? "オンライン購入者" :
                       category === "ニュース" ? "一般読者" : "ウェブサイト訪問者"
            };
        }
        
        // フォールバック用デモデータ
        function demoSummarize(url) {
            const detailedSummaries = [
                {
                    category: "テクノロジー",
                    title: "最新AIとイノベーション情報サイト",
                    summary: "人工知能、機械学習、ブロックチェーンなどの最新技術トレンドを専門的に解説する情報メディア",
                    keyPoints: [
                        "毎日更新される業界ニュースと専門記事",
                        "エンジニア向けの技術解説とチュートリアル",
                        "スタートアップ企業の最新動向レポート",
                        "テックカンファレンスの詳細レポート"
                    ],
                    target: "エンジニア、研究者、技術系ビジネスパーソン"
                },
                {
                    category: "Eコマース",
                    title: "総合オンラインショッピングプラットフォーム",
                    summary: "日用品から電子機器まで幅広い商品を取り扱う大規模ECサイト",
                    keyPoints: [
                        "100万点以上の豊富な商品ラインナップ",
                        "当日配送・翌日配送サービス対応",
                        "レビューシステムによる品質保証",
                        "セール・キャンペーンを定期開催"
                    ],
                    target: "一般消費者、法人購買担当者"
                },
                {
                    category: "教育",
                    title: "プログラミング学習プラットフォーム",
                    summary: "初心者から上級者まで対応した包括的なプログラミング教育サービス",
                    keyPoints: [
                        "Python、JavaScript、Java等主要言語対応",
                        "実践的なプロジェクトベースの学習",
                        "現役エンジニアによるメンタリング",
                        "就職・転職サポートプログラム完備"
                    ],
                    target: "プログラミング学習者、キャリアチェンジ希望者"
                },
                {
                    category: "企業情報",
                    title: "革新的SaaSソリューション企業",
                    summary: "中小企業向けの業務効率化ツールを開発・提供するテクノロジー企業",
                    keyPoints: [
                        "クラウドベースの統合業務管理システム",
                        "AI活用による自動化機能を搭載",
                        "24時間365日のカスタマーサポート",
                        "セキュリティ対策とデータ保護を重視"
                    ],
                    target: "中小企業経営者、IT管理者"
                },
                {
                    category: "ニュース",
                    title: "総合ニュースメディア",
                    summary: "政治・経済・社会・国際情勢を幅広くカバーする大手ニュースサイト",
                    keyPoints: [
                        "リアルタイム速報と詳細分析記事",
                        "専門記者による独自取材レポート",
                        "動画ニュースと解説コンテンツ",
                        "地域密着型のローカルニュースも配信"
                    ],
                    target: "一般読者、ビジネスパーソン、学生"
                }
            ];
            return detailedSummaries[Math.floor(Math.random() * detailedSummaries.length)];
        }

        async function handleSummarize() {
            const url = urlInput.value.trim();
            
            if (!url) {
                showError('URLを入力してください');
                return;
            }

            if (!isValidUrl(url)) {
                showError('有効なURLを入力してください');
                return;
            }

            hideError();
            hideResult();
            showLoading();
            
            try {
                // Google APIキーが設定されている場合は実際のAPI使用、そうでなければデモ
                if (!GOOGLE_API_KEY || GOOGLE_API_KEY === 'YOUR_GOOGLE_API_KEY_HERE') {
                    // デモモード（実際のコンテンツ取得も試行）
                    await new Promise(resolve => setTimeout(resolve, 1500));
                    
                    try {
                        // 実際のコンテンツを取得してみる
                        const content = await fetchWebContent(url);
                        if (content && content.length > 200) {
                            // 簡易分析（デモ用）
                            const analysisResult = analyzeContentDemo(content, url);
                            showResult(analysisResult);
                        } else {
                            throw new Error('コンテンツが不十分');
                        }
                    } catch {
                        // 取得失敗時はランダムデモ
                        const summary = demoSummarize(url);
                        showResult(summary);
                    }
                } else {
                    // 実際のAPI使用
                    const content = await fetchWebContent(url);
                    if (!content || content.length < 100) {
                        throw new Error('取得したコンテンツが不十分です');
                    }
                    const summary = await summarizeWithGoogle(content);
                    showResult(summary);
                }
            } catch (err) {
                showError(err.message);
            } finally {
                hideLoading();
            }
        }

        function isValidUrl(string) {
            try {
                new URL(string);
                return true;
            } catch (_) {
                return false;
            }
        }

        function showLoading() {
            loading.style.display = 'block';
            summarizeBtn.disabled = true;
        }

        function hideLoading() {
            loading.style.display = 'none';
            summarizeBtn.disabled = false;
        }

        function showError(message) {
            error.textContent = message;
            error.style.display = 'block';
        }

        function hideError() {
            error.style.display = 'none';
        }

        function showResult(summaryData) {
            if (typeof summaryData === 'string') {
                resultText.innerHTML = `<div class="summary-content">${summaryData}</div>`;
            } else {
                const html = `
                    <div class="summary-section">
                        <div class="summary-label">カテゴリ</div>
                        <div class="category-tag">${summaryData.category}</div>
                    </div>
                    
                    <div class="summary-section">
                        <div class="summary-label">サイトタイトル</div>
                        <div class="summary-content">${summaryData.title}</div>
                    </div>
                    
                    <div class="summary-section">
                        <div class="summary-label">概要</div>
                        <div class="summary-content">${summaryData.summary}</div>
                    </div>
                    
                    <div class="summary-section">
                        <div class="summary-label">主要ポイント</div>
                        <ul class="key-points">
                            ${summaryData.keyPoints.map(point => `<li>${point}</li>`).join('')}
                        </ul>
                    </div>
                    
                    <div class="summary-section">
                        <div class="summary-label">ターゲット</div>
                        <div class="summary-content">${summaryData.target}</div>
                    </div>
                `;
                resultText.innerHTML = html;
            }
            result.style.display = 'block';
        }

        function hideResult() {
            result.style.display = 'none';
        }

        // Event listeners
        summarizeBtn.addEventListener('click', handleSummarize);
        urlInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                handleSummarize();
            }
        });

        // Resize canvas on window resize
        window.addEventListener('resize', () => {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
        });
    </script>
</body>
</html>